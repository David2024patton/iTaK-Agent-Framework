# iTaK API Gateway Stack
# All local services organized under one compose project

services:
  # ============================================
  # Ollama - Local LLM Server
  # ============================================
  ollama:
    image: ollama/ollama
    container_name: ollama
    restart: unless-stopped
    ports:
      - "11434:11434"
    volumes:
      - ollama-data:/root/.ollama
    environment:
      - OLLAMA_HOST=0.0.0.0

  # ============================================
  # ChromaDB - Vector Memory Database
  # ============================================
  chromadb:
    image: chromadb/chroma
    container_name: chromadb
    restart: unless-stopped
    ports:
      - "29800:8000"
    volumes:
      - chromadb-data:/chroma/chroma

  # ============================================
  # Redis - Caching, Queues, Session Storage
  # ============================================
  redis:
    image: redis:7-alpine
    container_name: redis
    restart: unless-stopped
    profiles:
      - optional
    ports:
      - "63790:6379"
    volumes:
      - redis-data:/data
    command: redis-server --appendonly yes

  # ============================================
  # Whisper - Speech-to-Text (GPU accelerated)
  # ============================================
  whisper:
    image: onerahmet/openai-whisper-asr-webservice:latest-gpu
    container_name: whisper
    restart: unless-stopped
    profiles:
      - optional
    ports:
      - "59247:9000"
    environment:
      - ASR_MODEL=base
      - ASR_ENGINE=openai_whisper
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [ gpu ]

  # ============================================
  # Playwright - Browser Automation Server (DEPRECATED)
  # NOTE: Replaced by agent-browser CLI (npm install -g agent-browser)
  # Kept for backwards compatibility, use 'docker compose --profile optional up'
  # ============================================
  playwright:
    image: mcr.microsoft.com/playwright:v1.40.0-jammy
    container_name: playwright
    restart: unless-stopped
    profiles:
      - optional
    command: npx -y playwright@1.40.0 run-server --port 39281
    ports:
      - "39281:39281"
    extra_hosts:
      - "host.docker.internal:host-gateway"

  # ============================================
  # SearXNG - Meta-Search Engine (finds URLs)
  # ============================================
  searxng:
    image: searxng/searxng:latest
    container_name: searxng
    restart: unless-stopped
    ports:
      - "48192:8080"
    environment:
      - SEARXNG_BASE_URL=http://localhost:48192/
      - INSTANCE_NAME=itak-search

  # ============================================
  # Crawl4AI - Web Crawler (scrapes content for LLMs)
  # ============================================
  crawl4ai:
    image: unclecode/crawl4ai:latest
    container_name: crawl4ai
    restart: unless-stopped
    ports:
      - "47836:11235"
    environment:
      - CRAWL4AI_API_TOKEN=itak

  # ============================================
  # ComfyUI - AI Image Generation (GPU accelerated)
  # ============================================
  comfyui:
    image: yanwk/comfyui-boot:cu124-cn
    container_name: comfyui
    restart: unless-stopped
    profiles:
      - optional
    ports:
      - "58127:8188"
    volumes:
      - comfyui-data:/root
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [ gpu ]

  # ============================================
  # Supabase - PostgreSQL + Auth + Storage
  # ============================================
  supabase-db:
    image: supabase/postgres:15.6.1.143
    container_name: supabase-db
    restart: unless-stopped
    profiles:
      - optional
    ports:
      - "54321:5432"
    environment:
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: postgres
    volumes:
      - supabase-data:/var/lib/postgresql/data
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U postgres" ]
      interval: 10s
      timeout: 5s
      retries: 5

  supabase-studio:
    image: supabase/studio:20241202-71e5240
    container_name: supabase-studio
    restart: unless-stopped
    profiles:
      - optional
    ports:
      - "54323:3000"
    environment:
      STUDIO_PG_META_URL: http://supabase-db:5432
      SUPABASE_URL: http://localhost:54321
      SUPABASE_ANON_KEY: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZS1kZW1vIiwicm9sZSI6ImFub24iLCJleHAiOjE5ODM4MTI5OTZ9.CRXP1A7WOeoJeXxjNni43kdQwgnWNReilDMblYTn_I0
    depends_on:
      supabase-db:
        condition: service_healthy

  # ============================================
  # FRP Client - VPS Tunnel (starts when configured)
  # ============================================
  frpc:
    image: snowdreamtech/frpc
    container_name: frpc
    restart: unless-stopped
    profiles:
      - tunnel # Only starts when explicitly requested
    volumes:
      - ./frpc.toml:/etc/frp/frpc.toml
    extra_hosts:
      - "host.docker.internal:host-gateway"
    network_mode: host

volumes:
  ollama-data:
  chromadb-data:
  redis-data:
  comfyui-data:
  supabase-data:


